name: Build, Package and Deploy Spring Boot App with HTTPS

on:
  push:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create SSL keystore file for deployment
        working-directory: ./backend
        run: |
          echo "${{ secrets.SSL_KEYSTORE_BASE64 }}" | base64 --decode > src/main/resources/keystore.p12
          
      - name: Build with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Prepare deployment folder
        run: |
          mkdir -p ./backend/deploy
          cp ./backend/target/*.jar ./backend/deploy/app.jar

      - name: Create app.yaml
        working-directory: ./backend/deploy
        env:
          DATABASE_ADDRESS: ${{ secrets.DATABASE_ADDRESS }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          JWT_SERVER_KEY: ${{ secrets.JWT_SERVER_KEY }}
          CLIENT_INSTANCE_ADDRESS: ${{ secrets.CLIENT_INSTANCE_ADDRESS }}
          GITLAB_INSTANCE_ADDRESS: ${{ secrets.GITLAB_INSTANCE_ADDRESS }}
          GITLAB_INSTANCE_CLIENT_ID: ${{ secrets.GITLAB_INSTANCE_CLIENT_ID }}
          GITLAB_INSTANCE_CLIENT_SECRET: ${{ secrets.GITLAB_INSTANCE_CLIENT_SECRET }}
          BACKEND_DOMAIN_ADDRESS: ${{ secrets.BACKEND_DOMAIN_ADDRESS }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          cat > app.yaml <<EOF
          runtime: java17
          entrypoint: java -jar app.jar
          instance_class: B2
          basic_scaling:
            max_instances: 1
            idle_timeout: 10m
          env_variables:
            SPRING_PROFILES_ACTIVE: prod
            DATABASE_ADDRESS: "$DATABASE_ADDRESS"
            DATABASE_NAME: "$DATABASE_NAME"
            DATABASE_USERNAME: "$DATABASE_USERNAME"
            DATABASE_PASSWORD: "$DATABASE_PASSWORD"
            JWT_SERVER_KEY: "$JWT_SERVER_KEY"
            CLIENT_INSTANCE_ADDRESS: "$CLIENT_INSTANCE_ADDRESS"
            GITLAB_INSTANCE_ADDRESS: "$GITLAB_INSTANCE_ADDRESS"
            GITLAB_INSTANCE_CLIENT_ID: "$GITLAB_INSTANCE_CLIENT_ID"
            GITLAB_INSTANCE_CLIENT_SECRET: "$GITLAB_INSTANCE_CLIENT_SECRET"
            BACKEND_DOMAIN_ADDRESS: "$BACKEND_DOMAIN_ADDRESS"
            SERVER_PORT: "$SERVER_PORT"
          EOF

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Deploy to App Engine
        uses: google-github-actions/deploy-appengine@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          deliverables: ./backend/deploy
          promote: true
          flags: --verbosity debug

      - name: Clean up keystore file
        if: always()
        run: rm -f ./backend/src/main/resources/keystore.p12
